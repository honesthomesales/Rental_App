(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[74],{6101:function(e,t,a){Promise.resolve().then(a.bind(a,1812))},1812:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return h}});var r=a(7573),s=a(7653),n=a(269),l=a(3172),i=a(5731),d=a(8410),o=a(2966),c=a(8146),u=a(2548),m=a(2346);class x{static async getAll(){try{let e=(0,m.Ng)(),{data:t,error:a}=await e.from("RENT_payments").select("*").order("created_at",{ascending:!1});if(a)return(0,m.ql)(null,(0,m.Iu)(a));return(0,m.ql)(t)}catch(e){return(0,m.ql)(null,(0,m.Iu)(e))}}static async getByDateRange(e,t){try{let a=(0,m.Ng)(),{data:r,error:s}=await a.from("RENT_payments").select("*").gte("payment_date",e).lte("payment_date",t).order("payment_date",{ascending:!1});if(s)return(0,m.ql)(null,(0,m.Iu)(s));return(0,m.ql)(r)}catch(e){return(0,m.ql)(null,(0,m.Iu)(e))}}static async getMostRecentMonthWithPayments(){try{let e=(0,m.Ng)(),{data:t,error:a}=await e.from("RENT_payments").select("payment_date").order("payment_date",{ascending:!1}).limit(1);if(a)return(0,m.ql)(null,(0,m.Iu)(a));if(!t||0===t.length){let e=new Date;return(0,m.ql)({year:e.getFullYear(),month:e.getMonth()})}let r=t[0],s=new Date(r.payment_date);return(0,m.ql)({year:s.getFullYear(),month:s.getMonth()})}catch(e){return(0,m.ql)(null,(0,m.Iu)(e))}}static async getPropertiesWithTenants(){try{let e=(0,m.Ng)(),{data:t,error:a}=await e.from("RENT_properties").select("id, name, address, city, state, monthly_rent, notes").order("name");if(a)return(0,m.ql)(null,(0,m.Iu)(a));let{data:r,error:s}=await e.from("RENT_tenants").select("id, first_name, last_name, property_id").eq("is_active",!0);if(s)return(0,m.ql)(null,(0,m.Iu)(s));let{data:n,error:l}=await e.from("RENT_leases").select("id, tenant_id, rent_cadence, rent, lease_start_date, lease_end_date, status").eq("status","active");if(l)return(0,m.ql)(null,(0,m.Iu)(l));let i=(t||[]).map(e=>{let t=(r||[]).filter(t=>t.property_id===e.id),a=(n||[]).filter(e=>t.some(t=>t.id===e.tenant_id));return{...e,tenants:t,leases:a}});return(0,m.ql)(i)}catch(e){return(0,m.ql)(null,(0,m.Iu)(e))}}static async createPayment(e){try{let t=(0,m.Ng)(),{data:a,error:r}=await t.from("RENT_payments").insert([{payment_date:e.payment_date,amount:e.amount,property_id:e.property_id,tenant_id:e.tenant_id,payment_type:e.payment_type,notes:e.notes}]).select().single();if(r)return(0,m.ql)(null,(0,m.Iu)(r));return(0,m.ql)(a)}catch(e){return(0,m.ql)(null,(0,m.Iu)(e))}}static async updatePayment(e,t){try{let a=(0,m.Ng)(),{data:r,error:s}=await a.from("RENT_payments").update(t).eq("id",e).select().single();if(s)return(0,m.ql)(null,(0,m.Iu)(s));return(0,m.ql)(r)}catch(e){return(0,m.ql)(null,(0,m.Iu)(e))}}static async deletePayment(e){try{let t=(0,m.Ng)(),{error:a}=await t.from("RENT_payments").delete().eq("id",e);if(a)return(0,m.ql)(null,(0,m.Iu)(a));return(0,m.ql)(!0)}catch(e){return(0,m.ql)(null,(0,m.Iu)(e))}}static async getByPropertyAndDateRange(e,t,a){try{let r=(0,m.Ng)(),{data:s,error:n}=await r.from("RENT_payments").select("*").eq("property_id",e).gte("payment_date",t).lte("payment_date",a).order("payment_date",{ascending:!1});if(n)return(0,m.ql)(null,(0,m.Iu)(n));return(0,m.ql)(s)}catch(e){return(0,m.ql)(null,(0,m.Iu)(e))}}}class y{static async createRentPeriods(e,t){try{let a=(0,m.Ng)();if(!t.lease_start_date||!t.rent||!t.rent_cadence)return(0,m.ql)(null,"Missing lease information");let r=[],s=new Date(t.lease_start_date),n=new Date,l=new Date(s);for(;l<=n;){let a=new Date(l),s=(a<n?Math.floor((n.getTime()-a.getTime())/864e5):0)>5,i=0;if(s)switch(t.rent_cadence.toLowerCase().trim()){case"weekly":i=10;break;case"bi-weekly":case"biweekly":case"bi_weekly":i=20;break;default:i=50}switch(r.push({tenant_id:e.id,property_id:e.property_id||"",lease_id:t.id,period_due_date:a.toISOString().split("T")[0],rent_amount:t.rent,rent_cadence:t.rent_cadence,status:"unpaid",amount_paid:0,late_fee_applied:i,late_fee_waived:!1,due_date_override:void 0,notes:void 0}),t.rent_cadence.toLowerCase().trim()){case"weekly":l.setDate(l.getDate()+7);break;case"bi-weekly":case"biweekly":case"bi_weekly":l.setDate(l.getDate()+14);break;default:l.setMonth(l.getMonth()+1)}}let{data:i,error:d}=await a.from("RENT_rent_periods").insert(r).select("*");if(d)return(0,m.ql)(null,(0,m.Iu)(d));return(0,m.ql)(i)}catch(e){return(0,m.ql)(null,(0,m.Iu)(e))}}static async getTenantRentPeriods(e){try{let t=(0,m.Ng)(),{data:a,error:r}=await t.from("RENT_rent_periods").select("*").eq("tenant_id",e).order("period_due_date",{ascending:!0});if(r)return(0,m.ql)(null,(0,m.Iu)(r));return(0,m.ql)(a)}catch(e){return(0,m.ql)(null,(0,m.Iu)(e))}}static async updateRentPeriod(e,t){try{let a=(0,m.Ng)(),{data:r,error:s}=await a.from("RENT_rent_periods").update(t).eq("id",e).select("*").single();if(s)return(0,m.ql)(null,(0,m.Iu)(s));return(0,m.ql)(r)}catch(e){return(0,m.ql)(null,(0,m.Iu)(e))}}static async calculateTenantOwedAmount(e){try{let t=await this.getTenantRentPeriods(e);if(!t.success||!t.data)return(0,m.ql)(null,t.error);let a=t.data,r=0,s=0,n=0;for(let e of a)if("paid"!==e.status){let t=e.rent_amount-e.amount_paid;r+=t,e.late_fee_applied>0&&!e.late_fee_waived&&(s+=e.late_fee_applied),t>0&&n++}return(0,m.ql)({totalOwed:r,totalLateFees:s,missedPeriods:n,periods:a})}catch(e){return(0,m.ql)(null,(0,m.Iu)(e))}}static async allocatePayment(e,t){try{let a=(0,m.Ng)(),r=t.map(t=>({payment_id:e,rent_period_id:t.rent_period_id,amount_allocated:t.amount})),{error:s}=await a.from("RENT_payment_allocations").insert(r);if(s)return(0,m.ql)(null,(0,m.Iu)(s));for(let e of t){let{data:t,error:r}=await a.from("RENT_rent_periods").select("amount_paid, rent_amount").eq("id",e.rent_period_id).single();if(r)return(0,m.ql)(null,(0,m.Iu)(r));let s=(t.amount_paid||0)+e.amount,n=s>=t.rent_amount?"paid":"partial",{error:l}=await a.from("RENT_rent_periods").update({amount_paid:s,status:n}).eq("id",e.rent_period_id);if(l)return(0,m.ql)(null,(0,m.Iu)(l))}return(0,m.ql)(!0)}catch(e){return(0,m.ql)(null,(0,m.Iu)(e))}}}function p(e){var t;let{isOpen:a,onClose:l,property:i,selectedDate:d,onDateChange:o,onSave:c,onUpdate:m,onDelete:x,loading:p,editingPayment:h}=e,[g,b]=(0,s.useState)(""),[f,v]=(0,s.useState)("Rent"),[N,j]=(0,s.useState)(""),[w,_]=(0,s.useState)(!1),[k,D]=(0,s.useState)(0),[S,C]=(0,s.useState)(0),[P,q]=(0,s.useState)(!1),[I,L]=(0,s.useState)([]),[T,E]=(0,s.useState)({}),[R,Z]=(0,s.useState)("auto");(0,s.useEffect)(()=>{h?(b(h.amount.toString()),v(h.payment_type),j(h.notes||"")):(b(""),v("Rent"),j(""))},[h]),(0,s.useEffect)(()=>{var e,t;a&&(null==i?void 0:null===(t=i.tenants)||void 0===t?void 0:null===(e=t[0])||void 0===e?void 0:e.id)&&M()},[a,i]);let M=async()=>{var e,t;if(null==i?void 0:null===(t=i.tenants)||void 0===t?void 0:null===(e=t[0])||void 0===e?void 0:e.id)try{let e=await y.getTenantRentPeriods(i.tenants[0].id);e.success&&e.data&&L(e.data)}catch(e){console.error("Error loading rent periods:",e)}};if(!a||!i||!d)return null;let F=()=>{if(!i||!d||!g)return;let e=Math.floor((new Date().getTime()-d.getTime())/864e5);if(e>5){var t,a,r,s;(null===(a=i.leases)||void 0===a?void 0:null===(t=a[0])||void 0===t?void 0:t.rent)||i.monthly_rent;let n=(null===(s=i.leases)||void 0===s?void 0:null===(r=s[0])||void 0===r?void 0:r.rent_cadence)||"monthly",l=0;switch(n.toLowerCase().trim()){case"weekly":l=10;break;case"bi-weekly":case"biweekly":case"bi_weekly":l=20;break;default:l=50}let d=Math.ceil(e/(n.toLowerCase().includes("weekly")?7:30))*l;C(d),D(d),_(!0);return}A()},A=async()=>{if(!(!g||0>=parseFloat(g))){if(h&&m)m(h.id,{payment_date:d.toISOString().split("T")[0],amount:parseFloat(g),payment_type:f,notes:N});else{var e,t;if(c({payment_date:d.toISOString().split("T")[0],amount:parseFloat(g),property_id:i.id,tenant_id:(null===(t=i.tenants)||void 0===t?void 0:null===(e=t[0])||void 0===e?void 0:e.id)||"",payment_type:f,notes:N}),"Rent"===f&&I.length>0)try{setTimeout(async()=>{try{let e=[];if("auto"===R){let t=I.filter(e=>"paid"!==e.status).sort((e,t)=>new Date(e.period_due_date).getTime()-new Date(t.period_due_date).getTime()),a=parseFloat(g);for(let r of t){if(a<=0)break;let t=r.rent_amount-r.amount_paid;if(t>0){let s=Math.min(a,t);e.push({rent_period_id:r.id,amount:s}),a-=s}}}else e=Object.entries(T).map(e=>{let[t,a]=e;return{rent_period_id:t,amount:a}});e.length>0&&(console.log("Payment allocation would be:",e),u.ZP.success("Payment saved. Rent period allocation will be processed."))}catch(e){console.error("Error preparing payment allocation:",e)}},1e3)}catch(e){console.error("Error preparing payment allocation:",e)}}l()}},O=!!h;return(0,r.jsxs)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:[(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full mx-4",children:[(0,r.jsxs)("div",{className:"px-6 py-4 border-b border-gray-200 flex justify-between items-center",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:O?"Edit Payment":"Add Payment"}),(0,r.jsx)("button",{onClick:l,className:"text-gray-400 hover:text-gray-600 text-2xl font-bold",disabled:p,children:(0,r.jsx)(n.Z,{className:"w-6 h-6"})})]}),(0,r.jsx)("div",{className:"px-6 py-4",children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Property"}),(0,r.jsxs)("div",{className:"p-3 bg-gray-50 rounded-lg",children:[(0,r.jsx)("div",{className:"font-medium text-gray-900",children:i.name}),(0,r.jsx)("div",{className:"text-sm text-gray-500",children:i.address}),(null===(t=i.tenants)||void 0===t?void 0:t[0])&&(0,r.jsxs)("div",{className:"text-xs text-blue-600 mt-1",children:[i.tenants[0].first_name," ",i.tenants[0].last_name]})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Date"}),(0,r.jsx)("input",{type:"date",value:d.toISOString().split("T")[0],onChange:e=>{let t=new Date(e.target.value);!isNaN(t.getTime())&&o&&o(t)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",disabled:p})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Amount"}),(0,r.jsx)("input",{type:"number",min:"0",step:"0.01",value:g,onChange:e=>b(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter payment amount",autoFocus:!0,disabled:p})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Type"}),(0,r.jsxs)("select",{value:f,onChange:e=>v(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",disabled:p,children:[(0,r.jsx)("option",{value:"Rent",children:"Rent"}),(0,r.jsx)("option",{value:"Deposit",children:"Deposit"}),(0,r.jsx)("option",{value:"Late Fee",children:"Late Fee"}),(0,r.jsx)("option",{value:"Utility",children:"Utility"}),(0,r.jsx)("option",{value:"Other",children:"Other"})]})]}),"Rent"===f&&I.length>0&&(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Payment Allocation"}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("div",{className:"flex items-center space-x-4",children:(0,r.jsxs)("label",{className:"flex items-center",children:[(0,r.jsx)("input",{type:"radio",value:"auto",checked:"auto"===R,onChange:e=>Z(e.target.value),className:"mr-2"}),(0,r.jsx)("span",{className:"text-sm",children:"Auto-allocate to oldest unpaid periods"})]})}),(0,r.jsx)("div",{className:"flex items-center space-x-4",children:(0,r.jsxs)("label",{className:"flex items-center",children:[(0,r.jsx)("input",{type:"radio",value:"manual",checked:"manual"===R,onChange:e=>Z(e.target.value),className:"mr-2"}),(0,r.jsx)("span",{className:"text-sm",children:"Manually select periods"})]})}),"manual"===R&&(0,r.jsxs)("div",{className:"mt-3 p-3 bg-gray-50 rounded-lg max-h-40 overflow-y-auto",children:[(0,r.jsx)("div",{className:"text-xs text-gray-600 mb-2",children:"Select rent periods to allocate payment to:"}),I.filter(e=>"paid"!==e.status).map(e=>{let t=e.rent_amount-e.amount_paid,a=T[e.id];return(0,r.jsxs)("div",{className:"flex items-center justify-between py-2 border-b border-gray-200 last:border-b-0",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("input",{type:"checkbox",checked:!!a,onChange:a=>{if(a.target.checked)E(a=>({...a,[e.id]:Math.min(t,parseFloat(g)||0)}));else{let t={...T};delete t[e.id],E(t)}},className:"mr-2"}),(0,r.jsxs)("span",{className:"text-sm",children:[new Date(e.period_due_date).toLocaleDateString()," - $",t.toLocaleString()," owed"]})]}),a&&(0,r.jsx)("input",{type:"number",min:"0",max:t,step:"0.01",value:T[e.id]||0,onChange:a=>{let r=parseFloat(a.target.value)||0;E(a=>({...a,[e.id]:Math.min(r,t)}))},className:"w-20 px-2 py-1 text-sm border border-gray-300 rounded"})]},e.id)})]})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),(0,r.jsx)("textarea",{value:N,onChange:e=>j(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:3,placeholder:"Optional notes about this payment",disabled:p})]})]})}),(0,r.jsxs)("div",{className:"px-6 py-4 border-t border-gray-200 flex justify-end space-x-3",children:[(0,r.jsx)("button",{onClick:l,className:"px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors",disabled:p,children:"Cancel"}),O&&(0,r.jsx)("button",{onClick:()=>{confirm("Are you sure you want to delete this payment?")&&h&&x&&(x(h.id),l())},className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:p,children:"Delete Payment"}),(0,r.jsxs)("button",{onClick:()=>{F()},disabled:!g||0>=parseFloat(g)||p,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center",children:[p&&(0,r.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),p?O?"Updating...":"Saving...":O?"Update Payment":"Save Payment"]})]})]}),w&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full mx-4",children:[(0,r.jsxs)("div",{className:"px-6 py-4 border-b border-gray-200",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"Late Payment Detected"}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 mt-1",children:["This payment is ",Math.floor((new Date().getTime()-d.getTime())/864e5)," days late."]})]}),(0,r.jsx)("div",{className:"px-6 py-4",children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Calculated Late Fee"}),(0,r.jsx)("div",{className:"p-3 bg-gray-50 rounded-lg",children:(0,r.jsxs)("span",{className:"text-lg font-medium text-red-600",children:["$",S.toLocaleString()]})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Override Late Fee Amount"}),(0,r.jsx)("input",{type:"number",min:"0",step:"0.01",value:k,onChange:e=>D(parseFloat(e.target.value)||0),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter late fee amount"}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Set to 0 to waive late fees completely"})]})]})}),(0,r.jsxs)("div",{className:"px-6 py-4 border-t border-gray-200 flex justify-end space-x-3",children:[(0,r.jsx)("button",{onClick:()=>_(!1),className:"px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors",children:"Cancel"}),(0,r.jsx)("button",{onClick:()=>{j(N+"\n\nLate Fee Applied: $".concat(k.toLocaleString())),_(!1),A()},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Apply Late Fee & Save"})]})]})})]})}function h(){var e,t;let[a,n]=(0,s.useState)([]),[m,y]=(0,s.useState)([]),[h,g]=(0,s.useState)(!0),[b,f]=(0,s.useState)("Loading data..."),[v,N]=(0,s.useState)(""),[j,w]=(0,s.useState)(-3),[_,k]=(0,s.useState)("grid"),[D,S]=(0,s.useState)(null),[C,P]=(0,s.useState)(!1),[q,I]=(0,s.useState)(null),[L,T]=(0,s.useState)(null),[E,R]=(0,s.useState)(!1),[Z,M]=(0,s.useState)(null),F=()=>{let e=new Date(B[0]);e.setDate(e.getDate()-3);let t=new Date(B[B.length-1]);return t.setDate(t.getDate()+3),{start:e.toISOString().split("T")[0],end:t.toISOString().split("T")[0]}},[A,O]=(0,s.useState)([]),[W,U]=(0,s.useState)(0),z=(0,s.useCallback)(async()=>{try{g(!0),f("Loading data...");let e=Date.now(),t=F(),a=A;if(e-W>3e5||0===A.length){f("Loading properties and tenants...");let t=await x.getPropertiesWithTenants();if(!t.success||!t.data)throw Error(t.error||"Failed to load properties");a=t.data,O(t.data),U(e)}n(a),f("Loading payments...");let r=await x.getByDateRange(t.start,t.end);r.success?y(r.data||[]):(console.warn("Failed to load payments:",r.error),y([]))}catch(e){console.error("Error in memoizedLoadData:",e),u.ZP.error("Error loading data: "+e.message),n([]),y([])}finally{g(!1)}},[A,W,j]),B=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:8,t=[],a=new Date;for(;5!==a.getDay();)a.setDate(a.getDate()-1);a.setDate(a.getDate()+7*j);for(let r=0;r<e;r++)t.push(new Date(a)),a.setDate(a.getDate()+7);return t}(8);(0,s.useMemo)(()=>F(),[B]);let $=e=>{if(e.leases&&e.leases.length>0){let t=e.leases[0].rent_cadence;if(t)switch(t.toLowerCase().trim()){case"weekly":return"weekly";case"bi-weekly":case"biweekly":case"bi_weekly":return"bi-weekly"}}return"monthly"},J=e=>{switch($(e)){case"weekly":return 1;case"bi-weekly":return 2;default:return 3}},X=(0,s.useMemo)(()=>{let e=a;if(v.trim()){let t=v.toLowerCase();e=a.filter(e=>e.name.toLowerCase().includes(t)||e.address.toLowerCase().includes(t)||e.city.toLowerCase().includes(t)||e.state.toLowerCase().includes(t))}return e.sort((e,t)=>J(e)-J(t))},[a,v]),Y=(0,s.useCallback)(e=>{N(e.target.value)},[]),G=(0,s.useCallback)(e=>{g(!0),f("Loading week data..."),"prev"===e?w(j-1):w(j+1)},[j]);(0,s.useCallback)(async(e,t)=>{var a,r;if(!e.tenants||0===e.tenants.length){u.ZP.error("No tenants assigned to this property");return}let s=e.tenants[0],n=(null===(r=e.leases)||void 0===r?void 0:null===(a=r[0])||void 0===a?void 0:a.rent)||e.monthly_rent||0;if(0===n){u.ZP.error("No rent amount set for this property");return}try{let a={payment_date:t.toISOString().split("T")[0],amount:n,property_id:e.id,tenant_id:s.id,payment_type:"Rent",notes:"Auto-generated payment for ".concat(t.toLocaleDateString())};await V(a),u.ZP.success("Payment created successfully")}catch(e){u.ZP.error("Failed to create payment")}},[]);let V=(0,s.useCallback)(async e=>{try{R(!0);let t=await x.createPayment(e);if(t.success){u.ZP.success("Payment saved successfully");let e=F(),t=await x.getByDateRange(e.start,e.end);t.success&&y(t.data||[]),P(!1)}else u.ZP.error(t.error||"Failed to save payment")}catch(e){console.error("Error saving payment:",e),u.ZP.error("Error saving payment")}finally{R(!1)}},[]),H=(0,s.useCallback)(async(e,t)=>{try{R(!0);let a=await x.updatePayment(e,t);if(a.success){u.ZP.success("Payment updated successfully");let e=F(),t=await x.getByDateRange(e.start,e.end);t.success&&y(t.data||[]),P(!1),M(null)}else u.ZP.error(a.error||"Failed to update payment")}catch(e){console.error("Error updating payment:",e),u.ZP.error("Error updating payment")}finally{R(!1)}},[]),K=(0,s.useCallback)(async e=>{if(confirm("Are you sure you want to delete this payment?"))try{R(!0);let t=await x.deletePayment(e);if(t.success){u.ZP.success("Payment deleted successfully");let e=F(),t=await x.getByDateRange(e.start,e.end);t.success&&y(t.data||[]),P(!1),M(null)}else u.ZP.error(t.error||"Failed to delete payment")}catch(e){console.error("Error deleting payment:",e),u.ZP.error("Error deleting payment")}finally{R(!1)}},[]),Q=(0,s.useCallback)((e,t)=>{var r,s;let n=new Date(t);n.setDate(n.getDate()-6);let l=new Date(t),i=m.find(t=>{if(t.property_id!==e)return!1;let a=new Date(t.payment_date);return a>=n&&a<=l});if(i)return i;let d=a.find(t=>t.id===e);if(!(null==d?void 0:null===(s=d.tenants)||void 0===s?void 0:null===(r=s[0])||void 0===r?void 0:r.payment_history))return null;let o=d.tenants[0].payment_history.find(e=>{let t=new Date(e.date);return t>=n&&t<=l&&"completed"===e.status});return o?{id:"tenant-".concat(o.date),payment_date:o.date,amount:o.amount,property_id:e,tenant_id:d.tenants[0].id,payment_type:"Rent",notes:"From tenant payment history",created_at:o.date}:null},[m,a]),ee=(0,s.useCallback)((e,t)=>{I(e),T(t);let a=Q(e.id,t);a&&a.id&&!a.id.startsWith("tenant-")?M(a):M(null),P(!0)},[Q]),et=(0,s.useCallback)((e,t)=>{var r,s,n;let l;let i=a.find(t=>t.id===e);if(!i)return!1;let d=null===(r=i.leases)||void 0===r?void 0:r[0];if(!(null==d?void 0:d.rent_cadence))return!1;let o=d.rent_cadence.toLowerCase().trim();if(!("monthly"===o||"month"===o||(null==o?void 0:o.includes("month"))))return!1;let c=d.rent||i.monthly_rent||0;if(c<=0)return!1;let u=new Date(t.getFullYear(),t.getMonth(),1),x=new Date(t.getFullYear(),t.getMonth()+1,0);return l=0+m.filter(t=>{if(t.property_id!==e)return!1;let a=new Date(t.payment_date);return a>=u&&a<=x}).reduce((e,t)=>e+t.amount,0),(null==i?void 0:null===(n=i.tenants)||void 0===n?void 0:null===(s=n[0])||void 0===s?void 0:s.payment_history)&&(l+=i.tenants[0].payment_history.filter(e=>{let t=new Date(e.date);return t>=u&&t<=x&&"completed"===e.status}).reduce((e,t)=>e+t.amount,0)),l>=c},[m,a]),ea=(0,s.useCallback)(e=>{var t,a;let r=$(e),s=(null===(a=e.leases)||void 0===a?void 0:null===(t=a[0])||void 0===t?void 0:t.rent)||e.monthly_rent||0;return"monthly"===r?"$".concat(s.toLocaleString(),"/month"):"weekly"===r?"$".concat(s.toLocaleString(),"/week"):"bi-weekly"===r?"$".concat(s.toLocaleString(),"/bi-week"):"$".concat(s.toLocaleString(),"/").concat(r)},[]),er=(0,s.useCallback)(e=>{var t;let a=(null===(t=e.notes)||void 0===t?void 0:t.toLowerCase())||"";return a.includes("bi-weekly")||a.includes("biweekly")||a.includes("bi_weekly")||a.includes("bi-week")?"bi-weekly":a.includes("weekly")||a.includes("week")?"weekly":(a.includes("monthly")||a.includes("month"),"monthly")},[]),es=(0,s.useCallback)((e,t)=>{let r=er(e);if("monthly"===r)return et(e.id,t);if("bi-weekly"===r){var s;let r=new Date(t);r.setDate(r.getDate()-7);let n=Q(e.id,r);if(!n)return!1;let l=a.find(t=>t.id===e.id),i=null==l?void 0:null===(s=l.leases)||void 0===s?void 0:s[0];return(null==i?void 0:i.rent)||null==l||l.monthly_rent,n.amount>0}return!1},[et,Q,er,a]);return((0,s.useEffect)(()=>{A.length>0&&z()},[j]),(0,s.useEffect)(()=>{0===A.length&&z()},[]),h)?(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600 mx-auto mb-4"}),(0,r.jsx)("p",{className:"text-lg text-gray-600",children:b})]})}):(0,r.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,r.jsx)("header",{className:"bg-white shadow-sm border-b border-gray-200",children:(0,r.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"Payment Tracking"}),(0,r.jsx)("p",{className:"text-gray-600",children:"Track rent payments across all properties"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsxs)("div",{className:"flex bg-gray-100 rounded-lg p-1",children:[(0,r.jsx)("button",{onClick:()=>{k("grid")},className:"px-3 py-1 rounded-md text-sm font-medium transition-colors ".concat("grid"===_?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"),children:"Grid View"}),(0,r.jsx)("button",{onClick:()=>{k("list")},className:"px-3 py-1 rounded-md text-sm font-medium transition-colors ".concat("list"===_?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"),children:"List View"})]}),(0,r.jsxs)("button",{onClick:()=>{I(null),T(null),M(null),P(!0)},className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center",children:[(0,r.jsx)(l.Z,{className:"w-4 h-4 mr-2"}),"Add Payment"]})]})]})})}),(0,r.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[(0,r.jsx)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 mb-6",children:(0,r.jsx)("div",{className:"p-6",children:(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 items-end",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Search Properties/Tenants"}),(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)(i.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),(0,r.jsx)("input",{type:"text",placeholder:"Search properties or tenants...",value:v,onChange:Y,className:"w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]}),(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("button",{onClick:()=>G("prev"),className:"p-2 rounded-lg border border-gray-300 hover:bg-gray-50",children:(0,r.jsx)(d.Z,{className:"w-4 h-4"})}),(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("p",{className:"text-sm font-medium text-gray-700",children:"Week Navigation"}),(0,r.jsxs)("p",{className:"text-xs text-gray-500",children:[B[0].toLocaleDateString("en-US",{month:"short",day:"numeric"})," - ",B[B.length-1].toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})]})]}),(0,r.jsx)("button",{onClick:()=>G("next"),className:"p-2 rounded-lg border border-gray-300 hover:bg-gray-50",children:(0,r.jsx)(o.Z,{className:"w-4 h-4"})})]}),(0,r.jsx)("div",{className:"text-right",children:(0,r.jsxs)("p",{className:"text-sm text-gray-600",children:["Showing ",X.length," of ",a.length," properties"]})})]})})}),0===X.length?(0,r.jsx)("div",{className:"bg-white rounded-lg shadow",children:(0,r.jsxs)("div",{className:"p-12 text-center",children:[(0,r.jsx)("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:v?"No properties found":"No properties with active tenants"}),(0,r.jsx)("p",{className:"text-gray-600 mb-4",children:v?"Try adjusting your search":"Properties need active tenants to appear in the payments grid"}),(0,r.jsxs)("div",{className:"text-sm text-gray-500 mb-4",children:["Debug info: Properties: ",a.length,", Payments: ",m.length]}),(0,r.jsxs)("div",{className:"flex space-x-4 justify-center",children:[!v&&(0,r.jsxs)(c.default,{href:"/properties/new",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center",children:[(0,r.jsx)(l.Z,{className:"w-4 h-4 mr-2"}),"Add Property"]}),(0,r.jsx)("button",{onClick:z,className:"bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700",children:"Retry Loading"})]})]})}):(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[(0,r.jsx)("button",{onClick:()=>w(e=>e-1),className:"bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700",children:"Previous Week"}),(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsxs)("h2",{className:"text-lg font-semibold text-gray-900",children:[null===(e=B[0])||void 0===e?void 0:e.toLocaleDateString("en-US",{month:"long",day:"numeric"})," - ",null===(t=B[B.length-1])||void 0===t?void 0:t.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})]}),(0,r.jsx)("p",{className:"text-sm text-gray-600",children:"Weekly payment tracking"}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Sorted by payment cadence: Weekly (1) → Bi-weekly (2) → Monthly (3)"})]}),(0,r.jsx)("button",{onClick:()=>w(e=>e+1),className:"bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700",children:"Next Week"})]}),"grid"===_&&(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"w-full",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{className:"bg-gray-50",children:[(0,r.jsx)("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-900 border-r border-gray-200",children:"Property"}),B.map((e,t)=>(0,r.jsx)("th",{className:"px-4 py-3 text-center text-sm font-medium text-gray-900 border-r border-gray-200",children:(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("span",{className:"font-semibold",children:e.toLocaleDateString("en-US",{weekday:"short"})}),(0,r.jsx)("span",{className:"text-xs text-gray-500",children:e.toLocaleDateString("en-US",{month:"short",day:"numeric"})})]})},t))]})}),(0,r.jsx)("tbody",{children:X.map((e,t)=>{var a;return(0,r.jsxs)("tr",{className:"border-b border-gray-200 hover:bg-blue-50 transition-colors ".concat(D===e.id?"bg-blue-50":""),onMouseEnter:()=>S(e.id),onMouseLeave:()=>S(null),children:[(0,r.jsx)("td",{className:"px-4 py-3 border-r border-gray-200",children:(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,r.jsx)("div",{className:"w-3 h-3 bg-green-500 rounded-full"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-medium text-gray-900 flex items-center space-x-2",children:(0,r.jsxs)("span",{children:[e.address," - ",ea(e)]})}),(null===(a=e.tenants)||void 0===a?void 0:a[0])&&(0,r.jsxs)("div",{className:"text-xs text-gray-400",children:[e.tenants[0].first_name," ",e.tenants[0].last_name]})]})]})}),B.map((t,a)=>{let s=Q(e.id,t),n=es(e,t);return(0,r.jsx)("td",{className:"px-4 py-3 text-center border-r border-gray-200 relative group cursor-pointer hover:bg-blue-50",onDoubleClick:()=>ee(e,t),title:s?"Double-click to edit payment":"Double-click to add payment",children:(0,r.jsx)("div",{className:"flex flex-col items-center",children:s?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("span",{className:"font-semibold text-green-600",children:["$",s.amount.toLocaleString()]}),(0,r.jsx)("span",{className:"text-xs text-gray-500",children:new Date(s.payment_date).toLocaleDateString()}),(0,r.jsx)("span",{className:"text-xs text-gray-400",children:s.payment_type})]}):n?(0,r.jsxs)("div",{className:"flex items-center justify-center",children:[(0,r.jsx)("input",{type:"checkbox",checked:!0,readOnly:!0,className:"w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500"}),(0,r.jsx)("span",{className:"text-xs text-green-600 ml-1",children:"Paid"})]}):(0,r.jsx)("span",{className:"text-gray-300 group-hover:text-gray-500 transition-colors",children:"-"})})},a)})]},e.id)})})]})}),"list"===_&&(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"w-full",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{className:"bg-gray-50",children:[(0,r.jsx)("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-900 border-r border-gray-200",children:"Property"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-900 border-r border-gray-200",children:"Tenant"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-900 border-r border-gray-200",children:"Payment Date"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-900 border-r border-gray-200",children:"Amount"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-900 border-r border-gray-200",children:"Payment Type"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-900",children:"Actions"})]})}),(0,r.jsx)("tbody",{children:X.map(e=>{let t=B.map(t=>Q(e.id,t)).filter(Boolean);if(0===t.length){var a;return(0,r.jsxs)("tr",{className:"border-b border-gray-200",children:[(0,r.jsx)("td",{className:"px-4 py-3 border-r border-gray-200",children:(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,r.jsx)("div",{className:"w-3 h-3 bg-gray-300 rounded-full"}),(0,r.jsx)("div",{children:(0,r.jsxs)("div",{className:"font-medium text-gray-900",children:[e.address," - ",ea(e)]})})]})}),(0,r.jsx)("td",{className:"px-4 py-3 border-r border-gray-200 text-gray-500",children:(null===(a=e.tenants)||void 0===a?void 0:a[0])?"".concat(e.tenants[0].first_name," ").concat(e.tenants[0].last_name):"No tenant"}),(0,r.jsx)("td",{className:"px-4 py-3 border-r border-gray-200 text-gray-500",colSpan:4,children:"No payments in this period"})]},e.id)}return t.map((t,a)=>{var s;return(0,r.jsxs)("tr",{className:"border-b border-gray-200",children:[(0,r.jsx)("td",{className:"px-4 py-3 border-r border-gray-200",children:(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,r.jsx)("div",{className:"w-3 h-3 bg-green-500 rounded-full"}),(0,r.jsx)("div",{children:(0,r.jsxs)("div",{className:"font-medium text-gray-900",children:[e.address," - ",ea(e)]})})]})}),(0,r.jsx)("td",{className:"px-4 py-3 border-r border-gray-200",children:(null===(s=e.tenants)||void 0===s?void 0:s[0])?"".concat(e.tenants[0].first_name," ").concat(e.tenants[0].last_name):"No tenant"}),(0,r.jsx)("td",{className:"px-4 py-3 border-r border-gray-200",children:t?new Date(t.payment_date).toLocaleDateString():"-"}),(0,r.jsx)("td",{className:"px-4 py-3 border-r border-gray-200 font-semibold text-green-600",children:t?"$".concat(t.amount.toLocaleString()):"-"}),(0,r.jsx)("td",{className:"px-4 py-3 border-r border-gray-200",children:t?t.payment_type:"-"}),(0,r.jsx)("td",{className:"px-4 py-3",children:(0,r.jsx)("button",{onClick:()=>{I(e),T(new Date((null==t?void 0:t.payment_date)||Date.now())),M(t),P(!0)},className:"text-blue-600 hover:text-blue-800 text-sm font-medium",children:"Edit"})})]},"".concat(e.id,"-").concat((null==t?void 0:t.id)||a))})})})]})})]}),(0,r.jsxs)("div",{className:"mt-6 bg-blue-50 p-4 rounded-lg",children:[(0,r.jsx)("h3",{className:"text-sm font-medium text-blue-900 mb-2",children:"Grid Legend"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm",children:[(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"w-4 h-4 bg-green-100 border border-green-300 rounded mr-2"}),(0,r.jsx)("span",{className:"text-blue-700",children:"Green cells = Payment received"})]}),(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"w-4 h-4 bg-gray-100 border border-gray-300 rounded mr-2"}),(0,r.jsx)("span",{className:"text-blue-700",children:"Gray cells = No payment"})]}),(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"w-4 h-4 bg-blue-100 border border-blue-300 rounded mr-2"}),(0,r.jsx)("span",{className:"text-blue-700",children:"Hover to highlight property row"})]}),(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"w-4 h-4 bg-blue-100 border border-blue-300 rounded mr-2"}),(0,r.jsx)("span",{className:"text-blue-700",children:"Double-click cells to add payments"})]}),(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("span",{className:"text-green-600 font-semibold mr-2",children:"$Amount"}),(0,r.jsx)("span",{className:"text-blue-700",children:"Payment amount = Actual payment received"})]}),(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("span",{className:"text-gray-500 text-xs mr-2",children:"Date"}),(0,r.jsx)("span",{className:"text-blue-700",children:"Date = When payment was received"})]}),(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("input",{type:"checkbox",checked:!0,readOnly:!0,className:"w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 mr-2"}),(0,r.jsx)("span",{className:"text-blue-700",children:"Checkbox = Monthly: full month paid, Bi-weekly: next week covered"})]})]})]})]}),(0,r.jsx)(p,{isOpen:C,onClose:()=>P(!1),property:q,selectedDate:L,onDateChange:T,onSave:V,onUpdate:H,onDelete:K,loading:E,editingPayment:Z})]})}},8410:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(4313).Z)("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]])},2966:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(4313).Z)("ChevronRight",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]])},3172:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(4313).Z)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},5731:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(4313).Z)("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]])},269:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(4313).Z)("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]])},8146:function(e,t,a){"use strict";a.d(t,{default:function(){return s.a}});var r=a(6340),s=a.n(r)},2346:function(e,t,a){"use strict";a.d(t,{Iu:function(){return o},Ng:function(){return d},ql:function(){return c}});var r=a(3334);let s="https://gnisgfojzrrnidizrycj.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduaXNnZm9qenJybmlkaXpyeWNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjgyMDMsImV4cCI6MjA2NzM0NDIwM30.jLRIt4mqNa-6rnWudT_ciCvfPC0i0WlWFrCgC7NbhYM",l=null,i=!1;function d(){if(l)return l;if(i)throw Error("Supabase client is already being initialized");try{return i=!0,l=function(){if(!s||!n)throw Error("Supabase configuration is missing. Please check your environment variables.");return(0,r.createClient)(s,n,{auth:{autoRefreshToken:!1,persistSession:!1,detectSessionInUrl:!1,storageKey:"rental-app-auth"},global:{headers:{"X-Client-Info":"rental-app-web"}}})}()}finally{i=!1}}function o(e){return(null==e?void 0:e.message)?e.message:(null==e?void 0:e.error_description)?e.error_description:"An unexpected error occurred"}function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return{data:e,error:t,success:!t}}(()=>{try{return d()}catch(e){return console.error("Failed to get Supabase client:",e),null}})()}},function(e){e.O(0,[334,134,340,293,528,744],function(){return e(e.s=6101)}),_N_E=e.O()}]);